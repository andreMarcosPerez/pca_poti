# ------------------------------------------------------------------------------
# -- @head: MECAI | MAI5002 | LLS ----------------------------------------------
# ------------------------------------------------------------------------------

# ------------------------------------------------------------------------------
# -- Clean ---------------------------------------------------------------------
# ------------------------------------------------------------------------------

rm(list=ls())
cat("\014")

# ------------------------------------------------------------------------------
# -- Library -------------------------------------------------------------------
# ------------------------------------------------------------------------------

source("svd.R")

if (!require("ggplot2")) {
  
  install.packages("ggplot2");
  library("ggplot2");
}

if (!require("reshape2")) {
  
  install.packages("reshape2");
  library("reshape2");
}

# ------------------------------------------------------------------------------
# -- Variable ------------------------------------------------------------------
# ------------------------------------------------------------------------------

#INPUT.FILE.NAME <- "facebook"
#INPUT.FILE.NAME <- "wine_red"
#INPUT.FILE.NAME <- "wine_white"
#INPUT.FILE.NAME <- "superconductor"
#INPUT.FILE.NAME <- "residential"

INPUT.PATH <- "../data/input/"
INPUT.FILE <- paste0(INPUT.FILE.NAME,".csv")

OUTPUT.PATH <- "../data/output/"
OUTPUT.FILE <- paste0(INPUT.FILE.NAME,"_lls.png")

# ------------------------------------------------------------------------------
# -- Main ----------------------------------------------------------------------
# ------------------------------------------------------------------------------

cat("\014")

# ----------------------------------------
# -- Data --------------------------------
# ----------------------------------------

# -- Read

A <- read.csv(file.path(INPUT.PATH,INPUT.FILE));

# -- Calculate lls using R

r.fit <- lm(data = A, formula = target ~.);
r.fit <- r.fit$coefficients;

# -- Separate target variable

b = cbind(c(A[,ncol(A)]));
A = as.matrix(A[,1:(ncol(A)-1)]);

# ----------------------------------------
# -- Eigenvalues and Eigenvectors --------
# ----------------------------------------

svd <- svd(A);

# ----------------------------------------
# -- Matrix rank -------------------------
# ----------------------------------------

r <- (Matrix::rankMatrix(t(A), method = "qr"));

# ----------------------------------------
# -- Calculate x that min || Ax - b ||^2 -
# ----------------------------------------

d <- t(svd$u) %*% b;
x <- svd$v %*% cbind(c(c(d[1:r] / svd$d[1:r], rep(0, length(svd$d) - r))));

# ----------------------------------------
# -- RMSE --------------------------------
# ----------------------------------------

RMSE <- RMSE(pred = (A %*% x), obs = b, na.rm = TRUE)

# ----------------------------------------
# -- Performance -------------------------
# ----------------------------------------

cat("\014")

print("# ----------------------------------------")
print(paste0("# -- Dataset | ", INPUT.FILE.NAME))
print("# ----------------------------------------")
print(paste0("# -- RMSE...............", round(mean(RMSE), digits = 4)))
print("# ----------------------------------------")

# ----------------------------------------
# -- Plot --------------------------------
# ----------------------------------------

ggplot() +
geom_segment(aes(x= c(1:nrow(x)), xend = c(1:nrow(x)), y=0, yend = x)) +
geom_point(aes(x = c(1:nrow(x)), y = x), shape = 21, colour = "black", fill = "#42B3D5", size = 2, stroke = 0.5) +
labs(title = paste0("Linear Least Squares | ",INPUT.FILE), subtitle = "Coefficients values of x in Ax = b", y="Coefficients", x="Features") +
theme_minimal(); #+
ggsave(paste0(OUTPUT.PATH,OUTPUT.FILE),width = 5,height = 5);
