# ------------------------------------------------------------------------------
# -- @head: MECAI | MAI5002 | PCA ----------------------------------------------
# ------------------------------------------------------------------------------

# ------------------------------------------------------------------------------
# -- Clean ---------------------------------------------------------------------
# ------------------------------------------------------------------------------

rm(list=ls())
cat("\014")

# ------------------------------------------------------------------------------
# -- Library -------------------------------------------------------------------
# ------------------------------------------------------------------------------

# ------------------------------------------------------------------------------
# -- Variable ------------------------------------------------------------------
# ------------------------------------------------------------------------------

DATA.REL.PATH <- "../data/"
DATA.FILE     <- "facebook.csv"

# ------------------------------------------------------------------------------
# -- Function ------------------------------------------------------------------
# ------------------------------------------------------------------------------

# ----------------------------------------
# -- Algorithm | QR ----------------------
# ----------------------------------------

QR <- function(A){
  
  V <- A;
  Q <- matrix(0, nrow = nrow(A), ncol = ncol(A));
  R <- matrix(0, nrow = ncol(A), ncol = ncol(A));
  
  # ----------------------------------------
  # -- TODO | QR ---------------------------
  # ----------------------------------------

  return(list(Q = Q, R = R));
  
}

# ----------------------------------------
# -- Algorithm | Francis -----------------
# ----------------------------------------

Francis <- function(A, tol){
  
  err <- Inf;
  V   <- diag(1,nrow(A));
  
  while (err > tol) {
    
    qr <- QR(A);
    A  <- qr$R %*% qr$Q;
    V  <- V %*% qr$Q;

    ERR <- A;
    ERR[upper.tri(ERR)] <- 0;
    diag(ERR) <- 0;
    err <- max(abs(ER));
    
  }
  
  D <- diag(A);
  
  return(list(V = V, D = D));
  
}

# ----------------------------------------
# -- Algorithm | SVD ---------------------
# ----------------------------------------

SVD <- function(A, tol){
  
  u  <- Francis(A %*% t(A), tol);
  vd <- Francis(t(A) %*% A, tol);
  
  S <- matrix(0, nrow = ncol(A), ncol = ncol(A));
  S[1:min(ncol(A),nrow(A)),1:min(ncol(A),nrow(A))] <- diag(sqrt(D))
  
  return(list(U = u$U, S = S, V = vd$V));
  
}

# ------------------------------------------------------------------------------
# -- Main ----------------------------------------------------------------------
# ------------------------------------------------------------------------------

# ----------------------------------------
# -- Data --------------------------------
# ----------------------------------------

# -- Read

X <- read.csv(file.path(DATA.REL.PATH,DATA.FILE));
X <- t(X);

# -- Center + Normalize

for (i in 1:nrow(X)) {
  
  rowMean <- 0;
  
  for (j in 1:ncol(X)) {
    
    rowMean <- rowMean + X[i,j];
  }
  
  rowMean  <- (rowMean / ncol(X));
  
  if (rowMean != 0) {
    
    X[i,] <- (X[i,] - rowMean);
    X[i,] <- (X[i,] / max(X[i,]));
    
  }
}

# ----------------------------------------
# -- Covariance --------------------------
# ----------------------------------------

# -- Sx = XX' / n-1

Sx <- (X %*% t(X)) / (ncol(X) - 1);
Z  <- Sx - cov(t(X));

# ----------------------------------------
# -- Decomposition -----------------------
# ----------------------------------------

# svd <- SVD(X);
